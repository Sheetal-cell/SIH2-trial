<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ekasruti: Comprehensive Indian Language Captioner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&family=Varela+Round&display=swap');
        
        /* --- DARK THEME CSS VARIABLES (Moody & Soft) --- */
        :root {
            --color-bg-body: #090C12; /* Deep Navy/Charcoal */
            --color-bg-card: rgba(20, 24, 33, 0.95); /* Card Background */
            --color-text-primary: #E5F4E3; 
            --color-text-secondary: #90A8B0; 
            --color-input-bg: rgba(35, 40, 50, 0.6); 
            --color-border: rgba(60, 68, 80, 0.7); 
            --color-accent-coral: #FF6B6B; /* Vibrant Coral */
            --color-accent-teal: #48E5C2; /* Aqua Green/Teal - LISTENING/TRANSLATION */
            --color-danger: #F94C66; 
            --color-warning: #FFC300; /* Amber Warning */
            --color-shadow-card: rgba(0, 0, 0, 0.4);
            --color-shadow-deep: rgba(0, 0, 0, 0.9);
        }

        /* --- BASE STYLES & FONT --- */
        body { 
            font-family: 'Inter', sans-serif; 
            transition: background-color 0.6s, color 0.6s; 
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden; /* Prevent horizontal scroll from animation sway */
            background-color: var(--color-bg-body); /* Ensure background is set */
            color: var(--color-text-primary);
        }
        
        /* --- BACKGROUND ANIMATION CSS (Pastel Bubbles) --- */
        
        @keyframes pastel-float-up {
            0% { transform: translate(0, 0) scale(1); opacity: 0.15; }
            50% { 
                /* Uses JS-defined custom property for horizontal sway */
                transform: translate(calc(var(--rand-x-offset) * 1px), -10vh) scale(1.05); 
                opacity: 0.35; 
            }
            100% { transform: translate(0, -100vh) scale(0.8); opacity: 0; }
        }

        .animated-element {
            position: absolute;
            bottom: -50px;
            pointer-events: none;
            will-change: transform, opacity;
            animation: pastel-float-up linear infinite;
            border-radius: 50%;
        }


        /* --- THEMED CLASSES --- */
        .themed-card { 
            background-color: var(--color-bg-card); 
            color: var(--color-text-primary); 
            border: 1px solid var(--color-border);
            box-shadow: 0 10px 30px var(--color-shadow-card), 0 0 5px var(--color-shadow-deep) inset;
            backdrop-filter: blur(8px); 
            -webkit-backdrop-filter: blur(8px);
            transition: all 0.4s ease-out;
        }

        /* --- BUTTON/INTERACTION STYLES --- */
        .btn-primary { 
            background-color: var(--color-accent-coral); 
            color: var(--color-bg-body);
            box-shadow: 0 4px 12px rgba(255, 107, 107, 0.4);
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94); 
        }
        .btn-primary:hover { 
            background-color: var(--color-accent-coral); 
            transform: translateY(-1px) scale(1.01); 
            box-shadow: 0 8px 25px rgba(255, 107, 107, 0.6);
        }
        .btn-secondary {
            background-color: var(--color-input-bg);
            border: 1px solid var(--color-border);
            color: var(--color-text-primary);
            transition: all 0.2s;
        }
        .btn-secondary:hover {
            background-color: var(--color-border);
        }
        
        /* Mic Listening State (Teal Pulse) */
        .mic-listening {
            background-color: var(--color-accent-teal) !important; 
            color: var(--color-bg-body) !important;
            box-shadow: 0 0 10px var(--color-accent-teal), 0 0 20px var(--color-accent-teal) inset !important; 
            animation: pulse 1.5s infinite, breath 3s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.03); opacity: 0.9; } 
        }
        @keyframes breath {
            0%, 100% { box-shadow: 0 0 8px var(--color-accent-teal), 0 0 15px var(--color-accent-teal) inset; }
            50% { box-shadow: 0 0 25px var(--color-accent-teal), 0 0 40px var(--color-accent-teal) inset; }
        }

        /* Text Pop Animation for New Translations (More dramatic) */
        @keyframes textPop {
            0% { opacity: 0; transform: scale(0.9) translateY(20px); filter: blur(5px); }
            50% { opacity: 1; transform: scale(1.05) translateY(-5px); filter: blur(0px); }
            100% { opacity: 1; transform: scale(1) translateY(0); }
        }
        .text-pop-animate {
            animation: textPop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.27); 
        }

        /* Status colors and inputs */
        .status-danger { color: var(--color-danger); }
        .status-warning { color: var(--color-warning); }
        .themed-input {
            background-color: var(--color-input-bg);
            color: var(--color-text-primary);
            border: 1px solid var(--color-border);
            transition: border-color 0.3s;
        }
        .themed-input:focus {
            border-color: var(--color-accent-teal);
            box-shadow: 0 0 0 2px rgba(72, 229, 194, 0.3);
        }

        /* Speaker Button Styles */
        .speaker-a-active { background-color: #6474E5; color: white; } /* Indigo */
        .speaker-b-active { background-color: #FACC15; color: #1C1E26; } /* Amber */
        
        /* Floating Notification Bar Style */
        #notification-bar {
            position: fixed; 
            bottom: 5%; 
            left: 50%; 
            transform: translateX(-50%) translateY(150%);
            z-index: 1000;
            opacity: 0;
            padding: 0.75rem 1.5rem;
            border-radius: 9999px;
            color: white;
            font-weight: 600;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.27);
        }
        .notification-show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <!-- BACKGROUND ANIMATION LAYER (Fixed, low z-index) -->
    <div id="background-animation" class="fixed inset-0 z-[1] overflow-hidden"></div> 

    <!-- Main Content Wrapper (z-index 10) -->
    <div class="w-full max-w-4xl mx-auto flex-grow z-10">
        
        <!-- Header: Branding -->
        <header class="flex justify-start items-center mb-8 p-2">
            <div class="flex items-center">
                <div class="p-3 rounded-full font-extrabold text-xl text-white hover:rotate-3 transition duration-300" style="background-color: var(--color-accent-coral);">EK</div>
                <div class="ml-3">
                    <h1 class="text-3xl font-extrabold" style="color: var(--color-accent-teal);">Ekasruti Dialogue</h1>
                    <p class="text-xs" style="color: var(--color-text-secondary);">23 Language STT & Translation Engine</p>
                </div>
            </div>
        </header>

        <!-- Control Panel -->
        <div class="themed-card p-6 rounded-3xl shadow-xl mb-8 flex flex-col gap-5">
            
            <!-- Row 1: Languages, Speaker & Mic Control -->
            <div class="flex flex-col md:flex-row gap-4 w-full">
                
                <!-- Language Selectors (Grouped) -->
                <div class="flex gap-4 w-full md:w-2/3">
                    <!-- Source Language Selector -->
                    <div class="flex flex-col gap-1 w-1/2">
                        <label for="source-language" class="text-sm font-medium" style="color: var(--color-text-secondary);">Source (Spoken)</label>
                        <select id="source-language" class="themed-input p-3 rounded-lg font-bold focus:outline-none focus:ring-0">
                            <!-- Options populated by JS -->
                        </select>
                    </div>
                    
                    <!-- Target Language Selector -->
                    <div class="flex flex-col gap-1 w-1/2">
                        <label for="target-language" class="text-sm font-medium" style="color: var(--color-text-secondary);">Target (Caption)</label>
                        <select id="target-language" class="themed-input p-3 rounded-lg font-bold focus:outline-none focus:ring-0">
                            <!-- Options populated by JS -->
                        </select>
                    </div>
                </div>

                <!-- Speaker Toggle & Mic Status (Grouped) -->
                <div class="flex gap-4 w-full md:w-1/3">
                    <div class="flex flex-col gap-1 flex-grow">
                        <label class="text-sm font-medium" style="color: var(--color-text-secondary);">Current Speaker</label>
                        <button id="speaker-toggle" class="p-3 rounded-lg font-bold transition duration-300 speaker-a-active text-center w-full">
                            Speaker A
                        </button>
                    </div>

                    <div class="flex flex-col gap-1 items-center justify-end">
                        <label class="text-sm font-medium" style="color: var(--color-text-secondary);">Mic</label>
                        <div id="mic-indicator-visual" class="p-3 rounded-lg bg-gray-500 text-white transition duration-300 shadow-inner flex-shrink-0" title="Microphone Status">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="h-5 w-5">
                                <path fill-rule="evenodd" d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4z" clip-rule="evenodd" />
                                <path fill-rule="evenodd" d="M11.668 11.28c.379.034.764.053 1.15.053 2.665 0 4.908-1.55 6.01-3.616a.75.75 0 01.373-.134.75.75 0 01.737.98 10.5 10.5 0 01-5.182 6.645 3.5 3.5 0 01-1.01.205c-.382 0-.756-.02-1.127-.058A7.5 7.5 0 015 12.378V10.75a.75.75 0 011.5 0v1.628c.365.04.735.066 1.11.066 1.259 0 2.454-.344 3.508-.957z" clip-rule="evenodd" />
                                <path d="M15.5 14.5a3 3 0 10-6 0v2a3 3 0 106 0v-2z" />
                            </svg>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Row 2: STT Warning -->
            <div id="stt-warning-box" class="p-3 rounded-xl border-2 hidden" style="border-color: var(--color-warning); background-color: rgba(255, 195, 0, 0.1);">
                <p id="stt-warning-text" class="text-sm font-medium status-warning">
                    ⚠️ **STT Note:** The browser's speech recognition for this language is limited. Input will be processed using the English code, relying on the LLM's advanced language identification for accurate results.
                </p>
            </div>


            <!-- Row 3: Tone Control -->
            <div class="flex flex-col gap-1 w-full">
                <label for="tone-input" class="text-sm font-medium" style="color: var(--color-text-secondary);">Translation Tone/Style Guide (Optional)</label>
                <input 
                    type="text" 
                    id="tone-input" 
                    placeholder="E.g., 'Translate cheerfully and formally' or 'Use casual, slangy tone'"
                    class="themed-input p-3 rounded-lg focus:ring-0 w-full"
                >
            </div>
        </div>

        <!-- Start Button (Coral Accent) -->
        <button id="toggle-mic" class="flex items-center justify-center gap-2 px-6 py-4 rounded-xl font-extrabold transition duration-300 transform w-full uppercase btn-primary shadow-2xl mb-8">
            <span id="mic-status-text">Start Continuous Captioning</span>
        </button>


        <!-- Live Captions Area & Controls -->
        <div class="themed-card p-6 rounded-3xl shadow-2xl mb-6">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 pb-2 border-b border-dashed" style="border-color: var(--color-border);">
                <h2 class="text-xl font-semibold" style="color: var(--color-accent-teal);">Live Translation Stream</h2>
                
                <!-- Font Size Controls -->
                <div class="flex items-center gap-2 mt-2 sm:mt-0">
                    <span class="font-medium" style="color: var(--color-text-secondary);">Caption Size:</span>
                    <button id="font-decrease" class="p-2 rounded-lg btn-secondary hover:scale-105 transition font-extrabold text-lg" title="Decrease Font">-</button>
                    <button id="font-increase" class="p-2 rounded-lg btn-secondary hover:scale-105 transition font-extrabold text-lg" title="Increase Font">+</button>
                </div>
            </div>
            
            <!-- 1. Current Prompt/Warning Box -->
            <div id="prompt-box" class="p-4 mb-5 rounded-2xl border-2 border-dashed" style="border-color: var(--color-danger); background-color: rgba(249, 76, 102, 0.1);" >
                <p id="current-caption-prompt" class="text-xl font-medium status-danger text-center transition-opacity duration-500">
                    Ready! Press the button above to start continuous captioning.
                </p>
                <div id="loading-spinner" class="hidden animate-spin rounded-full h-8 w-8 border-b-4 mx-auto" style="border-color: var(--color-accent-coral);"></div>
            </div>

            <!-- 3. Translated Text Box (Target Language) - Highlighted Teal/FOCUS -->
            <div class="mt-4 p-4 rounded-xl themed-input shadow-lg text-center border-2" style="border-color: var(--color-accent-teal); background-color: var(--color-input-bg);">
                <p class="text-sm font-semibold mb-1" id="translated-language-label" style="color: var(--color-accent-teal);">Translated Text (Hindi) - FOCUS:</p>
                <p id="translated-text-display" class="font-extrabold min-h-[40px] transition duration-300" style="font-size: 2.5rem; color: var(--color-accent-teal);">...</p>
            </div>

            <!-- 2. Source Text (Speaker & Simplified English) Box -->
            <div class="mt-4 p-4 rounded-xl themed-input">
                <p class="text-sm font-semibold mb-1"><span id="speaker-source-label" class="text-indigo-400 font-extrabold">Speaker A:</span> Simplified English</p>
                <p id="simplified-english-text" class="text-lg" style="color: var(--color-text-primary); min-height: 28px;">...</p>
            </div>
        </div>

        <!-- History Panel -->
        <div class="themed-card p-4 rounded-3xl mb-6">
            <div class="flex justify-between items-center cursor-pointer hover:bg-opacity-90 transition p-1 -m-1 rounded" onclick="document.getElementById('history-content').classList.toggle('hidden');">
                <h3 class="font-bold text-lg flex items-center gap-2" style="color: var(--color-text-primary);">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6" style="color: var(--color-accent-coral);">
                        <path fill-rule="evenodd" d="M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25ZM9.75 9A.75.75 0 0 0 9 9.75v4.5c0 .414.336.75.75.75h4.5a.75.75 0 0 0 .75-.75v-4.5a.75.75 0 0 0-.75-.75h-4.5Z" clip-rule="evenodd" />
                    </svg>
                    Caption History
                </h3>
                <button id="download-history" class="btn-primary px-4 py-1 text-sm rounded-lg hover:scale-105" title="Download History">
                    Download
                </button>
            </div>

            <div id="history-content" class="mt-4 hidden max-h-60 overflow-y-auto">
                <div id="caption-history-list" class="flex flex-col gap-3">
                    <!-- History items will be inserted here -->
                    <p id="history-placeholder" style="color: var(--color-text-secondary);" class="text-center italic mt-2">No captions recorded yet. Start talking!</p>
                </div>
            </div>
        </div>

        <!-- System Status/Log -->
        <div id="status-log" class="mt-2 p-4 rounded-xl themed-card text-sm border-l-4" style="border-color: var(--color-accent-teal);">
            <p style="color: var(--color-text-secondary);">System Ready. Waiting for activation.</p>
        </div>
    </div>
    
    <!-- Floating Notification Bar -->
    <div id="notification-bar" class="fixed bottom-5 left-1/2 -translate-x-1/2 py-2 px-5 text-sm transform transition-all duration-300"></div>


    <script type="module">
        // --- Language Data (22 Scheduled Indian Languages + English) ---
        // BCP-47 codes are used for the browser's Speech-to-Text (STT) input. 
        // For languages without a specific STT code, the fallback is 'en-US' (stt: false), 
        // relying on the LLM to identify and process the spoken language from the raw transcript.
        const ALL_LANGUAGES = [
            // Languages with strong BCP-47 support for Speech Recognition (stt: true)
            { name: "English", native: "English", code: "en-US", stt: true },
            { name: "Hindi", native: "हिंदी", code: "hi-IN", stt: true },
            { name: "Bengali", native: "বাংলা", code: "bn-IN", stt: true },
            { name: "Marathi", native: "मराठी", code: "mr-IN", stt: true },
            { name: "Telugu", native: "తెలుగు", code: "te-IN", stt: true },
            { name: "Tamil", native: "தமிழ்", code: "ta-IN", stt: true },
            { name: "Gujarati", native: "ગુજરાતી", code: "gu-IN", stt: true },
            { name: "Urdu", native: "اُردُو", code: "ur-IN", stt: true },
            { name: "Kannada", native: "ಕನ್ನಡ", code: "kn-IN", stt: true },
            { name: "Odia", native: "ଓଡ଼ିଆ", code: "or-IN", stt: true },
            { name: "Malayalam", native: "മലയാളം", code: "ml-IN", stt: true },
            { name: "Punjabi", native: "ਪੰਜਾਬੀ", code: "pa-IN", stt: true },
            { name: "Assamese", native: "অসমীয়া", code: "as-IN", stt: true },
            { name: "Nepali", native: "नेपाली", code: "ne-NP", stt: true },

            // Languages with limited/no direct BCP-47 code support for Speech Recognition (stt: false)
            // STT will use 'en-US' code, LLM handles the language identification and translation.
            { name: "Kashmiri", native: "کٲشُر", code: "en-US", stt: false }, 
            { name: "Konkani", native: "कोंकणी", code: "en-US", stt: false },
            { name: "Sanskrit", native: "संस्कृतम्", code: "en-US", stt: false },
            { name: "Sindhi", native: "سنڌي", code: "en-US", stt: false },
            { name: "Dogri", native: "डोगरी", code: "en-US", stt: false },
            { name: "Bodo", native: "बोडो", code: "en-US", stt: false },
            { name: "Maithili", native: "মৈথিলী", code: "en-US", stt: false },
            { name: "Santhali", native: "ᱥᱟᱱᱛᱟᱲᱤ", code: "en-US", stt: false },
            { name: "Manipuri (Meitei)", native: "মণিপুরী", code: "en-US", stt: false }
        ];

        // --- Firebase Imports & Setup (Required for Canvas) ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables for Firebase setup
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- DOM Elements ---
        const toggleMicButton = document.getElementById('toggle-mic');
        const micIndicatorVisual = document.getElementById('mic-indicator-visual');
        const currentCaptionPrompt = document.getElementById('current-caption-prompt');
        const promptBox = document.getElementById('prompt-box');
        const loadingSpinner = document.getElementById('loading-spinner');
        const statusLog = document.getElementById('status-log');
        const sourceLanguageSelect = document.getElementById('source-language');
        const targetLanguageSelect = document.getElementById('target-language');
        const translatedLanguageLabel = document.getElementById('translated-language-label');
        const simplifiedEnglishText = document.getElementById('simplified-english-text');
        const translatedTextDisplay = document.getElementById('translated-text-display');
        const fontDecreaseButton = document.getElementById('font-decrease');
        const fontIncreaseButton = document.getElementById('font-increase');
        const captionHistoryList = document.getElementById('caption-history-list');
        const historyPlaceholder = document.getElementById('history-placeholder');
        const downloadHistoryButton = document.getElementById('download-history');
        const notificationBar = document.getElementById('notification-bar');
        const sttWarningBox = document.getElementById('stt-warning-box');
        
        // FEATURE ELEMENTS
        const speakerToggleButton = document.getElementById('speaker-toggle');
        const speakerSourceLabel = document.getElementById('speaker-source-label');
        const toneInput = document.getElementById('tone-input');
        
        // --- State Variables ---
        let recognition;
        let isListening = false;
        let isProcessing = false; 
        let captionHistory = []; 
        let currentFontSize = 2.5; 
        let currentSpeaker = 'Speaker A'; 
        
        const MIN_FONT_SIZE = 1.5;
        const MAX_FONT_SIZE = 4.0;
        const FONT_STEP = 0.5;
        
        // --- Background Animation Constants & Setup ---
        const animationContainer = document.getElementById('background-animation');
        const NUM_PASTEL_BUBBLES = 30;
        const PASTEL_COLORS = ['#AEC6CF', '#FFDAB9', '#B399D4', '#77DD77', '#F49AC2', '#C3B1E1']; 

        function rand(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }

        function createPastelBubble() {
            const element = document.createElement('div');
            element.classList.add('animated-element');
            const size = rand(20, 80); 
            const duration = rand(20, 50); 
            const delay = rand(0, 15); 
            const leftPosition = rand(0, 100); 
            const swayOffset = rand(-150, 150); 
            const color = PASTEL_COLORS[rand(0, PASTEL_COLORS.length - 1)];

            element.style.left = `${leftPosition}%`;
            element.style.width = `${size}px`;
            element.style.height = `${size}px`;
            element.style.backgroundColor = color;
            element.style.animationDuration = `${duration}s`;
            element.style.animationDelay = `-${delay}s`;
            element.style.setProperty('--rand-x-offset', swayOffset); 
            animationContainer.appendChild(element);
        }

        function initializePastelAnimation() {
            for (let i = 0; i < NUM_PASTEL_BUBBLES; i++) {
                createPastelBubble();
            }
        }
        // --- END Background Animation Setup ---
        
        // --- API URL ---
        const apiKey = "AIzaSyBSXlBab087ifMqXRbXCF4B3I6p-SzNtr8" 
        const GEMINI_API_BASE_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`; 

        // --- Utility Functions ---

        /**
         * Finds language data by name.
         */
        function getLanguageDataByName(name) {
            return ALL_LANGUAGES.find(lang => lang.name === name);
        }

        /**
         * Shows a temporary, visually prominent notification bar.
         */
        function showNotification(message, isError = false) {
            notificationBar.textContent = message;
            
            const successColor = getComputedStyle(document.documentElement).getPropertyValue('--color-accent-teal').trim();
            const dangerColor = getComputedStyle(document.documentElement).getPropertyValue('--color-danger').trim();

            if (isError) {
                notificationBar.style.backgroundColor = dangerColor;
                notificationBar.style.boxShadow = `0 4px 15px ${dangerColor}80`;
            } else {
                notificationBar.style.backgroundColor = successColor;
                notificationBar.style.boxShadow = `0 4px 15px ${successColor}80`;
            }
            
            notificationBar.classList.add('notification-show');
            
            setTimeout(() => {
                notificationBar.classList.remove('notification-show');
            }, 2500);
        }

        /**
         * Logs status messages to the UI.
         */
        function updateStatus(message, colorClass = 'color-text-secondary') {
            const color = getComputedStyle(document.documentElement).getPropertyValue(`--${colorClass}`).trim() || '';
            statusLog.innerHTML = `<p style="color: ${color};">${new Date().toLocaleTimeString()} - ${message}</p>`;
        }

        /**
         * Handles exponential backoff for fetch retries.
         */
        async function fetchWithRetry(fn, maxRetries = 3) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    return await fn();
                } catch (error) {
                    if (i === maxRetries - 1) throw error;
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                    console.log(`API call failed. Retrying in ${delay.toFixed(0)}ms...`);
                }
            }
        }
        
        // --- Language List Population ---
        function populateLanguageSelectors() {
            // Populate Source Language Selector
            ALL_LANGUAGES.forEach(lang => {
                const option = document.createElement('option');
                option.value = lang.name; // Use language name as the value for ease of LLM prompting
                option.textContent = `${lang.name} (${lang.native})`;
                option.setAttribute('data-code', lang.code);
                option.setAttribute('data-stt-support', lang.stt);
                
                if (lang.name === "English") option.selected = true; // Default Source
                sourceLanguageSelect.appendChild(option);
            });

            // Populate Target Language Selector
            ALL_LANGUAGES.forEach(lang => {
                const option = document.createElement('option');
                option.value = lang.name; // Use language name as the value for LLM
                option.textContent = `${lang.name} (${lang.native})`;
                
                if (lang.name === "Hindi") option.selected = true; // Default Target
                targetLanguageSelect.appendChild(option);
            });
        }
        
        // --- Caption History & Download Functions ---

        /**
         * Adds a successful translation pair to the history array and updates the UI list.
         */
        function saveToHistory(sourceText, translatedText, targetLang, speaker, tone) {
            const timestamp = new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
            const newEntry = { timestamp, sourceText, translatedText, targetLang, speaker, tone };
            captionHistory.unshift(newEntry); 
            
            const speakerColor = (speaker === 'Speaker A') ? 'text-indigo-400' : 'text-yellow-400';

            const historyItem = document.createElement('div');
            historyItem.className = 'history-item p-3 rounded-lg themed-card transition-shadow hover:shadow-lg';
            historyItem.innerHTML = `
                <p class="text-xs" style="color: var(--color-text-secondary);">${timestamp} - <span class="${speakerColor} font-bold">${speaker}</span> to ${targetLang}${tone ? ' (Tone: ' + tone + ')' : ''}:</p>
                <p class="text-sm font-semibold" style="color: var(--color-text-primary);">${translatedText}</p>
                <p class="text-xs italic mt-1" style="color: var(--color-text-secondary);">Simplified English: ${sourceText}</p>
            `;
            captionHistoryList.prepend(historyItem);

            historyPlaceholder.classList.add('hidden');
        }

        /**
         * Downloads the current caption history as a plain text file.
         */
        function downloadHistory() {
            if (captionHistory.length === 0) {
                updateStatus("History is empty. Nothing to download!", 'status-danger');
                showNotification("History is empty!", true);
                return;
            }

            const downloadText = captionHistory.map(entry => {
                const toneInfo = entry.tone ? ` (Tone: ${entry.tone})` : '';
                return `[${entry.timestamp}] [${entry.speaker}] (${entry.targetLang}${toneInfo})\n  Simplified English: ${entry.sourceText}\n  Translation: ${entry.translatedText}`;
            }).join('\n---\n');

            const blob = new Blob([`Ekasruti Dialogue Caption History (23 Languages):\n\n${downloadText}`], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Ekasruti_Captions_${new Date().toISOString().slice(0, 10)}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            updateStatus("Caption history downloaded successfully!", 'color-accent-teal');
            showNotification("History downloaded!");
        }

        // --- Font Size Adjustment ---
        function updateFontSize() {
            translatedTextDisplay.style.fontSize = `${currentFontSize}rem`;
        }

        fontDecreaseButton.addEventListener('click', () => {
            currentFontSize = Math.max(MIN_FONT_SIZE, currentFontSize - FONT_STEP);
            updateFontSize();
            showNotification(`Size: ${currentFontSize.toFixed(1)}rem`);
        });

        fontIncreaseButton.addEventListener('click', () => {
            currentFontSize = Math.min(MAX_FONT_SIZE, currentFontSize + FONT_STEP);
            updateFontSize();
            showNotification(`Size: ${currentFontSize.toFixed(1)}rem`);
        });
        
        // --- Speaker Toggle Feature ---
        speakerToggleButton.addEventListener('click', () => {
            currentSpeaker = (currentSpeaker === 'Speaker A') ? 'Speaker B' : 'Speaker A';
            speakerToggleButton.textContent = currentSpeaker;
            
            const isA = currentSpeaker === 'Speaker A';
            
            speakerToggleButton.classList.remove(isA ? 'speaker-b-active' : 'speaker-a-active');
            speakerToggleButton.classList.add(isA ? 'speaker-a-active' : 'speaker-b-active');
            
            speakerSourceLabel.textContent = `${currentSpeaker}: Simplified English`;
            speakerSourceLabel.classList.remove(isA ? 'text-yellow-400' : 'text-indigo-400');
            speakerSourceLabel.classList.add(isA ? 'text-indigo-400' : 'text-yellow-400');

            showNotification(`Active speaker switched to ${currentSpeaker}`);
            updateStatus(`Active speaker changed to ${currentSpeaker}.`, 'color-accent-coral');
        });

        // --- ML/API Pipeline CORE ---

        async function callGeminiApi(rawTranscript, targetLanguage, sourceLanguageName, sourceLangCode, tone) {
            
            if (isProcessing) {
                updateStatus(`API is busy. Cannot process new request now.`, 'status-danger');
                return false;
            }

            isProcessing = true;
            loadingSpinner.classList.remove('hidden');
            
            // Change prompt box style to indicate processing
            promptBox.style.borderColor = `var(--color-accent-coral)`;
            promptBox.style.backgroundColor = `rgba(255, 107, 107, 0.1)`;
            
            updateStatus(`Processing speech and translating...`, 'color-accent-coral');

            let jsonText = null;
            try {
                // Clear displays temporarily while waiting for API
                simplifiedEnglishText.textContent = "Processing raw speech to simplified English...";
                translatedTextDisplay.textContent = "Translating...";
                translatedTextDisplay.classList.remove('text-pop-animate');

                // Determine instruction based on STT support
                let sttNote = "";
                if (sourceLangCode === "en-US" && sourceLanguageName !== "English") {
                     // This indicates the STT was using a fallback code. LLM needs to ID the language first.
                    sttNote = `The raw transcript was generated using a generic language model (like English) because a specific STT code was unavailable. The user was speaking ${sourceLanguageName}. You MUST first identify the spoken ${sourceLanguageName} content from the raw transcript before simplifying and translating.`;
                }

                const toneInstruction = tone ? `Additionally, ensure the output translation reflects the user's requested tone/style: "${tone}".` : '';

                const systemPrompt = `You are a Real-time Dialogue Captioning System's core ML engine. Your job is three-fold: 
                                      1. Take the raw speech transcript. ${sttNote}
                                      2. Simplify it into clear, concise, short **English** sentences, removing filler words and verbal pauses. This is for the simplified_english_text field.
                                      3. Translate the simplified English text into the target language: **${targetLanguage}**. This is for the translated_text field.
                                      ${toneInstruction}
                                      You must only return a JSON object following the provided schema.`;

                const userQuery = `Raw transcript from ${currentSpeaker}: "${rawTranscript}". Spoken language: ${sourceLanguageName}. Target language: ${targetLanguage}.`;

                const payload = {
                    contents: [{ parts: [{ text: userQuery }] }],
                    systemInstruction: {
                        parts: [{ text: systemPrompt }]
                    },
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "OBJECT",
                            properties: {
                                "simplified_english_text": { "type": "STRING", "description": "The simplified and concise English version of the raw transcript." },
                                "translated_text": { "type": "STRING", "description": "The translation of the simplified English text into the target language." }
                            },
                            "propertyOrdering": ["simplified_english_text", "translated_text"]
                        }
                    }
                };
                
                const fetchFn = () => fetch(GEMINI_API_BASE_URL, { 
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const response = await fetchWithRetry(fetchFn);
                if (!response.ok) {
                    const errorBody = await response.text();
                    console.error(`${response.status} Response Body:`, errorBody);
                    throw new Error(`HTTP error! status: ${response.status}. Response: ${errorBody.substring(0, 100)}...`);
                }
                const result = await response.json();
                
                jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!jsonText) throw new Error("API response was empty or malformed.");
                
                let parsedData;
                try {
                    parsedData = JSON.parse(jsonText);
                } catch (e) {
                    console.error("Failed to parse JSON response:", jsonText, e);
                    throw new Error(`API returned text but failed JSON parsing. Raw text start: ${jsonText.substring(0, 500)}...`);
                }
                
                const translatedCaption = parsedData.translated_text || 'Translation unavailable.';
                const simplifiedEnglish = parsedData.simplified_english_text || '(No simplified English provided)';
                
                // Update UI with the Text Pop animation
                simplifiedEnglishText.textContent = simplifiedEnglish;
                translatedTextDisplay.textContent = translatedCaption;
                translatedTextDisplay.classList.add('text-pop-animate');
                setTimeout(() => translatedTextDisplay.classList.remove('text-pop-animate'), 400); 

                // Save to history
                if (translatedCaption !== 'Translation unavailable.') {
                    saveToHistory(simplifiedEnglish, translatedCaption, targetLanguage, currentSpeaker, tone);
                }

                // Update the prompt box to show success
                currentCaptionPrompt.textContent = `${currentSpeaker} TRANSLATED: ${translatedCaption.substring(0, 45)}...`;
                promptBox.style.borderColor = `var(--color-accent-teal)`;
                promptBox.style.backgroundColor = `rgba(72, 229, 194, 0.1)`;

                showNotification(`Translated to ${targetLanguage}!`);
                updateStatus(`Caption delivered and saved to history.`, 'color-accent-teal');
                return true; 
            } catch (error) {
                console.error("Gemini API Error:", error);
                
                const errorMessage = `CRITICAL ERROR: Translation failed. Check console for details.`;

                simplifiedEnglishText.textContent = `Error: Simplification failed.`;
                translatedTextDisplay.textContent = `Error: Translation failed.`;
                
                currentCaptionPrompt.textContent = errorMessage;
                currentCaptionPrompt.classList.add('status-danger');

                updateStatus(`Critical error in ML pipeline: ${error.message}`, 'status-danger');
                showNotification(`Processing Failed!`, true);
                return false; 
            } finally {
                isProcessing = false;
                loadingSpinner.classList.add('hidden');

                // If no error is active, revert to default listening prompt
                if (!currentCaptionPrompt.textContent.includes("ERROR") && isListening) {
                    currentCaptionPrompt.textContent = `MIC ACTIVE: Listening for next sentence...`;
                    currentCaptionPrompt.classList.remove('status-danger');
                    currentCaptionPrompt.style.color = `var(--color-text-secondary)`;
                    
                    // Re-apply warning box border if STT support is limited
                    const selectedOption = sourceLanguageSelect.options[sourceLanguageSelect.selectedIndex];
                    const hasSTTSupport = selectedOption.getAttribute('data-stt-support') === 'true';
                    
                    if (!hasSTTSupport) {
                        promptBox.style.borderColor = `var(--color-warning)`;
                        promptBox.style.backgroundColor = `rgba(255, 195, 0, 0.1)`;
                    } else {
                        promptBox.style.borderColor = `var(--color-border)`;
                        promptBox.style.backgroundColor = `var(--color-input-bg)`;
                    }

                } else if (!currentCaptionPrompt.textContent.includes("ERROR") && !isListening) {
                    currentCaptionPrompt.textContent = 'Ready! Press the button above to start continuous captioning.';
                    currentCaptionPrompt.classList.remove('themed-text-secondary'); 
                    currentCaptionPrompt.classList.add('status-danger');
                    promptBox.style.borderColor = `var(--color-danger)`;
                    promptBox.style.backgroundColor = `rgba(249, 76, 102, 0.1)`;
                }
            }
        }


        // --- Speech Recognition (STT Module) ---

        function setupSpeechRecognition() {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                updateStatus('ERROR: Web Speech API not supported. Use Chrome or Edge.', 'status-danger');
                toggleMicButton.disabled = true;
                return;
            }

            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();

            // Initial Language setting (will be updated on start)
            recognition.lang = getLanguageDataByName(sourceLanguageSelect.value).code; 
            recognition.continuous = true; 
            recognition.interimResults = true; 

            recognition.onstart = () => {
                isListening = true;
                toggleMicButton.classList.remove('btn-primary');
                toggleMicButton.classList.add('mic-listening');
                micIndicatorVisual.classList.add('mic-listening');
                micIndicatorVisual.classList.remove('bg-gray-500');
                
                document.getElementById('mic-status-text').textContent = 'STOP LISTENING';

                simplifiedEnglishText.textContent = "Listening for a complete sentence...";
                translatedTextDisplay.textContent = "Waiting for input...";
                
                currentCaptionPrompt.textContent = "MIC ACTIVE: Listening for next sentence...";
                currentCaptionPrompt.classList.remove('status-danger');
                currentCaptionPrompt.style.color = `var(--color-text-secondary)`;

                // Adjust prompt box based on STT support
                const selectedOption = sourceLanguageSelect.options[sourceLanguageSelect.selectedIndex];
                const hasSTTSupport = selectedOption.getAttribute('data-stt-support') === 'true';
                
                if (!hasSTTSupport) {
                    promptBox.style.borderColor = `var(--color-warning)`;
                    promptBox.style.backgroundColor = `rgba(255, 195, 0, 0.1)`;
                } else {
                    promptBox.style.borderColor = `var(--color-border)`;
                    promptBox.style.backgroundColor = `var(--color-input-bg)`;
                }


                updateStatus('Microphone is ON and continuous. Capturing speech.', 'color-accent-teal');
                showNotification("Microphone is ACTIVE");
            };

            recognition.onend = () => {
                // Critical Fix for Mobile: Auto-restart loop
                if (isListening) { 
                    updateStatus('Mobile session ended (resource limit). Auto-restarting...', 'color-accent-coral');
                    try {
                        recognition.start();
                    } catch (e) {
                        console.error("Failed to auto-restart recognition:", e);
                        isListening = false; 
                        updateStatus('Auto-restart failed. Please manually restart.', 'status-danger');
                    }
                } else {
                    // Manual Stop UI Reset Logic
                    toggleMicButton.classList.remove('mic-listening');
                    toggleMicButton.classList.add('btn-primary');
                    micIndicatorVisual.classList.remove('mic-listening');
                    micIndicatorVisual.classList.add('bg-gray-500');
                    
                    document.getElementById('mic-status-text').textContent = 'Start Continuous Captioning';
                    
                    if (!isProcessing) {
                        currentCaptionPrompt.textContent = 'Ready! Press the button above to start continuous captioning.';
                        currentCaptionPrompt.classList.remove('themed-text-secondary'); 
                        currentCaptionPrompt.classList.add('status-danger');
                        promptBox.style.borderColor = `var(--color-danger)`;
                        promptBox.style.backgroundColor = `rgba(249, 76, 102, 0.1)`;
                    }
                    updateStatus('Microphone OFF. Ready for next dialogue.', 'color-text-secondary');
                }
            };
            
            recognition.onresult = (event) => {
                let interimTranscript = '';
                let finalTranscript = '';

                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript;
                    } else {
                        interimTranscript += transcript;
                    }
                }

                currentCaptionPrompt.textContent = `Capturing (${currentSpeaker}): ${interimTranscript}`;
                
                if (finalTranscript.length > 0) {
                    const selectedOption = sourceLanguageSelect.options[sourceLanguageSelect.selectedIndex];
                    const sourceLangName = selectedOption.value; // The language name
                    const sourceLangCode = selectedOption.getAttribute('data-code'); // The BCP-47 code
                    const targetLangName = targetLanguageSelect.value;
                    const tone = toneInput.value.trim();

                    updateStatus(`Final speech segment received from ${currentSpeaker} (${sourceLangName}).`, 'color-text-primary');
                    
                    // Process the final text WITHOUT stopping the microphone.
                    callGeminiApi(
                        finalTranscript.trim(), 
                        targetLangName, 
                        sourceLangName,
                        sourceLangCode,
                        tone
                    );
                }
            };

            recognition.onerror = (event) => {
                console.error('Speech Recognition Error:', event.error);
                updateStatus(`ERROR: Speech Recognition failed. (${event.error}).`, 'status-danger');
                showNotification(`Mic Error: ${event.error}`, true);
            };
        }

        // --- Event Listeners and Initialization ---

        function handleSourceLanguageChange() {
            const selectedOption = sourceLanguageSelect.options[sourceLanguageSelect.selectedIndex];
            const sourceLangName = selectedOption.value;
            const sourceLangCode = selectedOption.getAttribute('data-code');
            const hasSTTSupport = selectedOption.getAttribute('data-stt-support') === 'true';

            // Show or hide the STT warning box
            if (!hasSTTSupport) {
                sttWarningBox.classList.remove('hidden');
                updateStatus(`Source language set to ${sourceLangName}. Warning: Browser STT support is limited, relying on LLM ID.`, 'status-warning');
            } else {
                sttWarningBox.classList.add('hidden');
                updateStatus(`Source language set to ${sourceLangName} (STT code: ${sourceLangCode}).`, 'color-text-secondary');
            }
            showNotification(`Source: ${sourceLangName}`);

            if (recognition) {
                const wasListening = isListening;
                if(wasListening) recognition.stop();
                // Update the BCP-47 code for the next start
                recognition.lang = sourceLangCode; 
                if(wasListening) recognition.start();
            }
        }


        toggleMicButton.addEventListener('click', () => {
            if (!recognition) {
                setupSpeechRecognition();
            }
            if (isListening) {
                isListening = false;
                recognition.stop();
            } else {
                try {
                    isListening = true;
                    // Ensure the language is set using the BCP-47 code from the selected option's data attribute
                    const selectedOption = sourceLanguageSelect.options[sourceLanguageSelect.selectedIndex];
                    recognition.lang = selectedOption.getAttribute('data-code');
                    recognition.start();
                } catch (e) {
                    console.error("Recognition start error:", e);
                    updateStatus(`Error starting mic: ${e.message}`, 'status-danger');
                    showNotification("Could not start microphone.", true);
                }
            }
        });
        
        downloadHistoryButton.addEventListener('click', downloadHistory);
        sourceLanguageSelect.addEventListener('change', handleSourceLanguageChange);

        targetLanguageSelect.addEventListener('change', (e) => {
            translatedLanguageLabel.textContent = `Translated Text (${e.target.value}) - FOCUS:`;
            updateStatus(`Target language changed to ${e.target.value}.`, 'color-text-secondary');
            showNotification(`Target: ${e.target.value}`);
        });

        // Initialize Firebase (boilerplate requirement)
        function initializeFirebase() {
            if (firebaseConfig) {
                const app = initializeApp(firebaseConfig);
                const auth = getAuth(app);
                
                if (initialAuthToken) {
                    signInWithCustomToken(auth, initialAuthToken)
                        .then((userCredential) => {
                            console.log("Firebase signed in with custom token.", userCredential.user.uid);
                        })
                        .catch((error) => {
                            console.error("Firebase Auth Error (Custom Token):", error);
                        });
                } else {
                    signInAnonymously(auth)
                        .then((userCredential) => {
                            console.log("Firebase signed in anonymously.", userCredential.user.uid);
                        })
                        .catch((error) => {
                            console.error("Firebase Auth Error (Anonymous):", error);
                        });
                }
            } else {
                console.warn("Firebase config not available. Database features are disabled.");
            }
        }

        // Setup on window load
        window.onload = () => {
            populateLanguageSelectors();
            updateFontSize(); 
            initializeFirebase();
            setupSpeechRecognition();
            initializePastelAnimation(); 
            
            // Set initial labels based on default selections
            translatedLanguageLabel.textContent = `Translated Text (${targetLanguageSelect.value}) - FOCUS:`;
            speakerSourceLabel.textContent = `${currentSpeaker}: Simplified English`;

            updateStatus('Ekasruti Dialogue v2.0: 23-Language System loaded and ready! Speak to translate.', 'color-text-primary');
        };
    </script>
</body>
</html>
